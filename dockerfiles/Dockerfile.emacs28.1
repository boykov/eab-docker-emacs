ARG VERSION=20.04
FROM ubuntu:$VERSION as ubuntu-emacs

MAINTAINER eab <artscan@list.ru>

RUN echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf \
    && apt-get update && DEBIAN_FRONTEND="noninteractive" apt-get install \
    software-properties-common \
    libacl1-dev \
    librsvg2-dev \
    imagemagick \
    libdbus-1-dev \
    libotf-dev \
    libxpm-dev \
    libgif-dev \
    libjpeg-dev \
    libpng-dev \
    libtiff-dev \
    libx11-dev \
    libncurses5-dev \
    automake \
    bash \
    make \
    git \
    build-essential \
    autoconf \
    texinfo \
    libgtk2.0-dev \
    && add-apt-repository ppa:ubuntu-toolchain-r/test \
    && apt-get install \
    gcc-10 \
    g++-10 \
    libgccjit0 \
    libgccjit-10-dev \
    libjansson4 \
    libjansson-dev \
    libxml2-dev \
    libgnutls28-dev

COPY emacs-28.1 /emacs
COPY build.sh /emacs/build.sh
RUN cd /emacs && chmod +x build.sh && sleep 1 && ./build.sh
RUN rm -rf /emacs

FROM ubuntu-emacs

# basic stuff
RUN apt-get install \
    supervisor \
    openssh-server \
    dbus-x11 \
    fontconfig \
    gzip \
    language-pack-en-base \
    libgl1-mesa-glx \
    sudo \
    tar \
    unzip \
    expect \
    tmux \
    python \
    python-dev \
    python3-pip \
    openvpn \
    curl \
    man \
    strace \
    lsof \
    wget \
# su-exec
    && git clone https://github.com/ncopa/su-exec.git /tmp/su-exec \
    && cd /tmp/su-exec \
    && make \
    && chmod 770 su-exec \
    && mv ./su-exec /usr/local/sbin/ \
# git-wip
    && git clone https://github.com/bartman/git-wip.git && cp git-wip/git-wip /usr/bin \
# ripgrep
    && wget https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep-13.0.0-x86_64-unknown-linux-musl.tar.gz \
    && tar -xvf ripgrep-13.0.0-x86_64-unknown-linux-musl.tar.gz && cp -f ripgrep-13.0.0-x86_64-unknown-linux-musl/rg /usr/bin

COPY ru_RU /usr/share/i18n/locales/ru_RU
RUN locale-gen ru_RU && locale-gen ru_RU.UTF-8 && update-locale LANG=ru_RU.UTF-8 && dpkg-reconfigure --frontend noninteractive locales

RUN sed -i 's:^path-exclude=/usr/share/man:#path-exclude=/usr/share/man:' \
        /etc/dpkg/dpkg.cfg.d/excludes

# basic stuff
RUN apt-get update && apt-get install \
    man \
    manpages-posix \
    bc \
    cmake \
    ispell \
    xterm \
    graphviz \
    ansible \
    dictd \
    libtool-bin \
    libssl-dev \
# Cleanup
    && apt-get purge build-essential \
    && apt-get autoremove \
    && rm -rf /tmp/* /var/lib/apt/lists/* /root/.cache/*

RUN pip3 install cmake gitlabber

# ripgrep
RUN wget https://github.com/adobe-fonts/source-code-pro/archive/2.030R-ro/1.050R-it.zip \
    && unzip 1.050R-it.zip \
    && cp source-code-pro-*-it/OTF/*.otf /usr/local/share/fonts/ \
    && rm -rf source-code-pro* \
    && rm 1.050R-it.zip \
    fc-cache -f -v

COPY dictd/ /usr/share/dictd/
RUN dictdconfig -w
RUN dict -I

RUN mkdir /RNTM
COPY gpg.conf /RNTM/gpg.conf
COPY .eev /RNTM/.eev
COPY browser-remote /usr/local/bin/browser-remote
RUN chmod +x /usr/local/bin/browser-remote

RUN echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf \
    && apt-get update && DEBIAN_FRONTEND="noninteractive" apt-get install \
    ghostscript \
    sqlite3 \
    aspell \
    aspell-en \
    aspell-ru \
    figlet \
    libcanberra-gtk-module

RUN ln -s /var/lib/ispell/american.hash /var/lib/ispell/english.hash

RUN mkdir /var/run/sshd

COPY dockerfiles/asEnvUser /usr/local/sbin/

# Only for sudoers
RUN chown root /usr/local/sbin/asEnvUser \
    && chmod 700  /usr/local/sbin/asEnvUser


# Supervisor Config
COPY ./config/supervisor/supervisord.conf /etc/supervisord.conf
# Start Supervisord
COPY ./config/cmd.sh /
RUN chmod 755 /cmd.sh

ENV UNAME="emacser" \
    GNAME="emacs" \
    UHOME="/home/emacs" \
    UID="1000" \
    GID="1000" \
    WORKSPACE="/mnt/workspace" \
    EDAEMON="server" \
    SHELL="/bin/bash"

WORKDIR "${WORKSPACE}"

ENTRYPOINT ["asEnvUser"]
CMD ["bash", "-c", "/cmd.sh"]
